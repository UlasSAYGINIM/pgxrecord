{{- $G := . -}}
package {{ .PackageName }}

import (
	"github.com/jackc/pgsql"
	"github.com/jackc/pgx/v4"
	"github.com/jackc/pgxrecord"
	"github.com/jackc/pgtype"
	pgtypeuuid "github.com/jackc/pgtype/ext/gofrs-uuid"
	"github.com/gofrs/uuid"
	shopspring "github.com/jackc/pgtype/ext/shopspring-numeric"
	"github.com/shopspring/decimal"
)

type {{ .StructName }} struct {
{{ range .Columns }}	{{ .FieldName }} {{ .FieldType }}
{{ end }}}

func ({{ .ReceiverName }} *{{ .StructName }}) InsertQuery() (sql string, queryArgs []interface{}) {
	sql = `insert into {{ .TableName }}(
{{ range $i, $c := .InsertColumns }}{{ if gt $i 0 }},
{{ end }}  {{ .ColumnName }}{{ end }}
) values (
{{ range $i, $c := .InsertColumns }}{{ if gt $i 0 }},
{{ end }}  ${{ add $i 1 }}{{ end }}
){{ if .InsertReturningColumns }}
returning
{{ range $i, $c := .InsertReturningColumns }}{{ if gt $i 0 }},
{{ end }}  {{ .ColumnName }}{{ end }}
{{- end -}}
`

	queryArgs = []interface{}{
		{{ range .InsertColumns -}}
		{{ $G.ReceiverName }}.{{ .FieldName }},
		{{ end }}}

	return sql, queryArgs
}

{{ if .InsertReturningColumns }}
func ({{ .ReceiverName }} *{{ .StructName }}) InsertScan(rows pgx.Rows) error {
	return rows.Scan(
		{{ range .InsertReturningColumns -}}
		&{{ $G.ReceiverName }}.{{ .FieldName }},
		{{ end -}}
	)
}
{{ end }}

func ({{ .ReceiverName }} *{{ .StructName }}) UpdateData() ([]*pgsql.Assignment) {
	assignments := make([]*pgsql.Assignment, 0, {{ len .Columns }})

	{{ range $i, $c := .Columns }}
	if {{ $G.ReceiverName }}.{{ .FieldName }}.Status != pgtype.Undefined {
		assignments = append(assignments, &pgsql.Assignment{Left: pgsql.Ident{`{{ .ColumnName }}`}, Right: pgsql.Param{Value: {{ $G.ReceiverName }}.{{ .FieldName }}}})
	}
	{{ end }}

	return assignments
}

func ({{ .ReceiverName }} *{{ .StructName }}) TableName() string {
	return `{{ .TableName }}`
}

func ({{ .ReceiverName }} *{{ .StructName }}) WherePrimaryKey() (*pgsql.SelectStatement) {
	s := &pgsql.SelectStatement{}
	{{ range .PrimaryKeyColumns -}}
	s.Where("{{ .ColumnName }}=?", {{ $G.ReceiverName }}.{{ .FieldName }})
	{{ end -}}
	return s
}

func ({{ .ReceiverName }} *{{ .StructName }}) SelectStatement() *pgsql.SelectStatement {
	return pgsql.Select(`{{ range $i, $c := .SelectColumns }}{{ if gt $i 0 }}, {{ end }}{{ $G.TableName}}.{{ .ColumnName }}{{ end }}`).From(`{{ .TableName }}`)
}

func ({{ .ReceiverName }} *{{ .StructName }}) SelectScan(rows pgx.Rows) error {
	return rows.Scan(
		{{ range .SelectColumns -}}
		&{{ $G.ReceiverName }}.{{ .FieldName }},
		{{ end }})
}

type {{ .StructName }}Collection []*{{ .StructName }}

func (c *{{ .StructName }}Collection) NewRecord() pgxrecord.Selector {
	return &{{ .StructName }}{}
}

func (c *{{ .StructName }}Collection) Append(s pgxrecord.Selector) {
	*c = append(*c, s.(*{{ .StructName }}))
}
